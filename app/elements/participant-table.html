<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="participant-table">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <paper-datatable data="[[_participantData]]">
      <paper-datatable-column header="Id" property="participantId" type="Number" align="right" sortable sorted
                              tooltip="Used for Debugging">
      </paper-datatable-column>

      <paper-datatable-column header="Name" property="name" type="String" style="width:99%;" sortable></paper-datatable-column>

      <paper-datatable-column header="Races" property="numRaces" type="Number" align="right" sortable></paper-datatable-column>

      <paper-datatable-column header="Finishes" property="numFinishes" type="Number" align="right" sortable>
          <template><span>[[value]]&nbsp;([[item.finishPercentage]]%)<span></template>
      </paper-datatable-column>

      <paper-datatable-column header="Wins" property="numWins" type="Number" align="right" sortable></paper-datatable-column>

      <paper-datatable-column header="Podium Finishes" property="numPodiums" type="Number" align="right" sortable></paper-datatable-column>

      <paper-datatable-column header="Time vs. Median" property="timeVsMedian" type="Number" align="right" sortable
                              tooltip="How a player compares to the median time in the legs they raced.  Smaller is better" >
                              <template><span>[[value]]%<span></template>
      </paper-datatable-column>

      <paper-datatable-column header="Skill Rating" property="currentSkillRating" type="Number" align="right" sortable
                              tooltip="The Conservative Rating of the player">
      </paper-datatable-column>

     </paper-datatable>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'participant-table',

      properties: {
        dttData: {
          type: Object
        },
        _participantData: {
          type: Array,
          computed: '_getParticipantData(dttData)'
        }
      },

      _getParticipantData() {
        console.time('Participant Data');
        let participants = this.dttData.participants.map((participant) => {
          let skill = participant.driverSkill;
          let item = {
            participantId: participant.participantId,
            name: `${participant.name.lastname}, ${participant.name.firstname}`,
            currentSkillMean: skill ? skill.mean.toFixed(2) : 'n/a',
            currentSkillRating: skill ? skill.conservativeRating.toFixed(2) : 'n/a',
            races: [],
            numRaces: 0,
            numFinishes: 0,
            finishPercentage: 0,
            _totalTime: 0,
            _medianTime: 0,
            timeVsMedian: 0
          };
          return item;
        });

        for (let result of this.dttData.results) {
          let participant = participants[result.driverId];
          if (typeof participant !== 'undefined') {
            if (result.leg === 1) {
              participant.numRaces++;
            }
            if ((result.dnf === false) && (result.unknownTime === false)) {
              participant._totalTime += result.legTime;
              participant._medianTime +=
                      this.dttData.races[result.raceId].legMedianTimes[result.leg];
              if (result.leg === this.dttData.races[result.raceId].legs) {
                participant.numFinishes++;
              }
            }
          }
        }

        for (let participant of participants) {
          if (typeof participant !== 'undefined') {
            participant.finishPercentage =
                (participant.numFinishes / participant.numRaces * 100).toFixed(0);
            if (participant._medianTime > 0) {
              participant.timeVsMedian = (participant._totalTime /
                                       participant._medianTime * 100).toFixed(1);
            } else { participant.timeVsMedian = '';}
          }
        }

        participants = participants.filter((participant) => {
          return participant.numRaces > 0;
        });

        console.timeEnd('Participant Data');
        return participants;
      },

    });
  })();
  </script>
</dom-module>
